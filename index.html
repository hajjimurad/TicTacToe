<!DOCTYPE html>
<html>
	<head>
		<title>Tic Tac Toe</title>
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.3.2/united/bootstrap.min.css" />
		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular.js"></script>
	</head>
	<body ng-app>
		<style type="text/css">
			.game {
				width: 302px;
				margin: 20px auto;
				overflow: hidden;
				font-family: Comic Sans MS;
				font-weight: bold;
				text-align: center;
			}
			.cpanel {
				margin: 20px auto;
				width: 302px;
			}
			.cpanel input[type=button]{
				width: 140px;
			}
			.game div.cell {
				width: 100px; 
				height: 100px; 
				border: solid 1px #000; 
				float: left;
				font-size: 64px;
				text-align: center;
			}
			.result {
				text-align: center;
				padding: 4px;
				height: 48px;
			}
			.cross {
				color: blue;
			}
			.nought {
				color: red;
			}
			.unavailable {
				visibility: hidden;
			}
		</style>
		<div ng-controller="GameController" ng-model="state">
			<!-- Panel to choose game type -->
			<div class="cpanel" ng-class="{ unavailable: gameType != null }">
				<input type="button" value="user first" ng-click="onSelectGame(false)">
				<input type="button" value="computer first" ng-click="onSelectGame(true)">
			</div>
			<!-- Place for game -->
			<div class="game" ng-class="{ unavailable: gameType == null }">				
				<div ng-repeat="item in states" ng-click="onUserClick($index)" class="cell" ng-class="{cross: item.state == 1, nought: item.state == 0}">
					{{showState(item)}}
				</div>
			</div>
			<!-- Result -->
			<h3 class="result">{{showResult(gameResult)}}</h3>
			<!-- Log records -->
			<ul>
				<li ng-repeat="record in log">{{record}}</li>
			</ul>
		</div>
		<script type="text/javascript">
		//--- entry point for game
		var GameController = function($scope) {
			//--- form constants
			var winSums = [7, 56, 448, 73, 146, 292, 273, 84];
			var anglePositions = [0,2,6,8];
			var sidePositions = [1,3,5,7];
			var centralPosition = 4;
			//--- game temp data
			var isCross;
			var resetRequired;
			var step;
			var firstUserPosition;
			var prevUserPosition;
			var computerStrategy;
			//---
			var initForm = function() {
				$scope.gameType = null;
				$scope.gameResult = null;
			};
			var startGame = function(gType) {
				step = 0;
				firstUserPosition = null;
				prevUserPosition = null;
				computerStrategy = null;
				$scope.gameType = gType;
				//---
				resetRequired = false;
				isCross = 0;
				//---
				$scope.log = [];
				$scope.states = [];
			 	for(var i=0; i<9; i++) {
			 		$scope.states.push({ state: null });
			 	};
				//---
				if($scope.gameType == 1) {
					isCross = 1;
					computerRun(isCross);
				}
			};
			//---
			initForm();
			//--- data to view
			$scope.showState = function(item) {
				if(item.state  == 0) return "0"; // ⭕
				if(item.state == 1) return "X"; // ❌
			};
			//--- shows game result
			$scope.showResult = function(gameResult) {
				switch(gameResult) {
					case 0:
						return 'Nobody won!';
					break;
					case 1:
						return 'Win of user \'X\'';
					break;
					case 2:
						return 'Win of user \'O\'';
					break;
					default:
						return null;
					break;
				}
			};
			//--- data to view
			$scope.onSelectGame = function(gameType) {
				startGame(gameType);
			};
            //---   				     
			$scope.onUserClick = function(index) {
				//--- game is finished
				if(resetRequired) {
					resetRequired = false;
					//---
					initForm();
					//---
					return;
				}
				//--- check if cell is available
				if($scope.states[index].state != null) 
					return;
				//--- update cell with new status
				isCross = (isCross + 1) % 2
				//---
				userRun(index,isCross);
				//--- check is result received
				if(isGameFinished()) {
					resetRequired = true;
					return;
				}
				//---
				isCross = (isCross + 1) % 2
				//--- computer turn
				computerRun(isCross);
				//--- check state again
				if(isGameFinished()) {
					resetRequired = true;
					return;
				}		
			};
			var isGameFinished = function() {
				//--- check if won X
				if(ifWin(0)) {
					$scope.gameResult = 2;
					//---
					return true;
				}
				//--- check if won 0
				if(ifWin(1)) {
					$scope.gameResult = 1;
					//---
					return true;
				}
				//--- check if game finished
				if(ifNoPlaceToGo()) {
					$scope.gameResult = 0;
					return true;
				}
				//---
				return false;
			};
			var userRun = function(index,isCross) {
				placeTo(index,isCross);
				//---
				step++;
				//--- 
				prevUserPosition = index;
				if(step == 1) {
					firstUserPosition = index;
				}
				return true;
			};
			var computerRun = function(isCross) {
				var chosen = false;
				var emptyPositions = [];
				//--- 'IF I CAN WIN THEN WIN'
				for(var i=0;i<9;i++) {
					if($scope.states[i].state == null) {
						//--- check if computer can win
						if(ifWin(isCross, i)) {	
							placeTo(i,isCross,"computer can win");		
							chosen = true;
							break;
						}
						emptyPositions.push(i);
					}
				}
				if(chosen)
					return;
				//--- 'IF OPPONENT CAN WIN AT NEXT STEP THEN GO THERE'
				var opponentSymbol = (isCross + 1) % 2;
				for(var i=0;i<9;i++) {
					if($scope.states[i].state == null) {
						//--- check if opponent can win
						if(ifWin(opponentSymbol, i)) {
							placeTo(i,isCross,"user can win");		
							chosen = true;
							break;
						}
					}
				}
				if(chosen)
					return;
				//---
				if($scope.gameType == 0) {
					//--- choose strategy
					if(!computerStrategy) {
						if(step == 1) {
							if($scope.states[centralPosition].state == 1) {
								computerStrategy = 1;
							}
							else if(isAnglePosition(opponentSymbol, prevUserPosition)) {
								computerStrategy = 2;
							}
							else if(isSidePosition(opponentSymbol, prevUserPosition)) {
								computerStrategy = 3;
							}
						}
					}
					//--- act by selected strategy
					if(computerStrategy == 1) {
						//--- choose any angle cell or random
						var anglePos = getFirstFreeAnglePosition();
						if(anglePos != null) {
							placeTo(anglePos,isCross,"user has already got center first (strategy 1 for noughts)");
						} else {
							var anyFreePosition = getFirstFree();
							placeTo(anyFreePosition,isCross,"user has already got center first and angle positions are not empty (strategy 1.1 for noughts)");
						}
					} else if(computerStrategy == 2) {
						if(step == 1) {
							placeTo(centralPosition,isCross,"user has already got angle (strategy 2 for noughts)")
						} else if (step == 2) {
							//--- find opposite position
							var oppositePositions = getPositionOpposite(firstUserPosition);
							if($scope.states[oppositePositions].state != null) {
								// //--- opposite position is used => find any at side
								var positionAtSide = getFirstFreeAtSide();
								placeTo(positionAtSide,isCross,"second step, at side (strategy 2 for noughts)");
							} else {
								placeTo(oppositePositions,isCross,"second step, opposite (strategy 2 for noughts)");
							}
						} else {
							var anyFree = getFirstFree();
							placeTo(anyFree,isCross,"any free (strategy 2 for noughts)");
						}
					} else if(computerStrategy == 3) {
						if(step == 1) {
							placeTo(centralPosition,isCross,"first step was at side (strategy 3.0 for noughts)");
						} else if(step == 2) {
							var tempPos;
							//----
							if(isAnglePosition(opponentSymbol, prevUserPosition)) {
								var oppositePosition = getPositionOpposite(prevUserPosition);
								placeTo(oppositePosition,isCross,"second step was at angle " + prevUserPosition + " (strategy 3.1 for noughts)");
							} else if(getPositionOpposite(prevUserPosition) == firstUserPosition) {
								var firstFreeAnglePosition = getFirstFreeAnglePosition();
								placeTo(firstFreeAnglePosition,isCross,"second step was at opposite to the first side (strategy 3.2 for noughts)");
							} else if(ifPositionNearAndAtSideToTheFirst(opponentSymbol,prevUserPosition,firstUserPosition, function(pos) { tempPos = pos})) {
								placeTo(tempPos,isCross,"second step was near at side (strategy 3.3 for noughts)");
							} else {
							var anyFree = getFirstFree();
							placeTo(anyFree,isCross,"any free (strategy 3 for noughts)");
							}
						} else {
							var anyFree = getFirstFree();
							placeTo(anyFree,isCross,"any free (strategy 3 for noughts)");
						}
					}
				}
				else if($scope.gameType == 1) {
					if(step == 0) {
						//--- get center
						placeTo(centralPosition,isCross,"need to start from center");
					}
					else {
						//--- find the most remote cell for reviousPosition
						var remoteToPrevious = getMostRemoteAngleTo(prevUserPosition);
						if(remoteToPrevious)
							placeTo(remoteToPrevious,isCross,"it's the most remoted angle to " + prevUserPosition + " (strategy for crosses by default)");						
						else {
							var anyFree = getFirstFree();
							placeTo(anyFree,isCross,"any free (strategy for crosses, when angle is not available");
						}
					}
				}
			};
			var placeTo = function(pos, isCross, reason) {
				if(!$scope.states) {
					throw "states are not initialized";
				}
				//---
				if(!$scope.states[pos]) {
					throw "state position is not initialized for " + pos + ", reason: " + reason;
				}
				//---
				if($scope.states[pos].state == null) {
					$scope.states[pos].state = isCross;
					var record = reason 
								 ? ("computer chose " + pos + ", because " + reason)
								 : "user chose " + pos;
					 //---
					console.log(record);
					$scope.log.push(record);
				}
				else {
					throw "invalid position to set for reason: " + reason;
				}
			};
			var getMostRemoteAngleTo = function(sourcePosition) {
				var maxDistance = 0;
				var maxRemotePosition;
				//---
				for(var i=0;i<anglePositions.length;i++) {
					if($scope.states[anglePositions[i]].state != null) 
						continue;
					//---
					var x = sourcePosition % 3;
					var y = (sourcePosition - x) / 3;
					//---
					var xAngle = anglePositions[i] % 3;
					var yAngle = (anglePositions[i] - xAngle) / 3;
					//---
					var distance = Math.abs(x - xAngle) + Math.abs(y - yAngle);
					//---
					if(maxDistance < distance) {
						maxDistance = distance;
						maxRemotePosition = anglePositions[i];
					}
				}
				return maxRemotePosition;
			};
			var ifPositionNearAndAtSideToTheFirst = function(isCross, position, firstPosition, callback) {
				if(!callback)
					return null;
				//---
				if(!isSidePosition(isCross,position)) {
					throw "position is not side to check if both are neighbours";
				}
				switch(position) {
					case 1:
						if(firstPosition == 3) { callback(0); return true; }
						if(firstPosition == 5) { callback(2); return true; }
					break; 
					case 3: 
						if(firstPosition == 1) { callback(0); return true; }
						if(firstPosition == 7) { callback(6); return true; }
					break; 
					case 5: 
						if(firstPosition == 1) { callback(2); return true; }
						if(firstPosition == 7) { callback(8); return true; }
					break; 
					case 7: 
						if(firstPosition == 3) { callback(6); return true; }
						if(firstPosition == 5) { callback(8); return true; }
					break;
				}
				//---
				return false;
			};
			var getPositionOpposite = function(sourcePosition) {
				if(sourcePosition == undefined) {
					throw "invalid position specified to get opposite, undefined";
				}
				if(sourcePosition == centralPosition) {
					throw "invalid position specified to get opposite, opposite";
				}
				var x = sourcePosition % 3;
				var y = (sourcePosition - x) / 3;
				var oppositeX = 2 - x;;
				var oppositeY = 2 - y;
				return oppositeY * 3 + oppositeX;
			};
			var getFirstFreeAtSide = function() {
				for(var i=0;i<sidePositions.length;i++) {
					if($scope.states[sidePositions[i]].state == null) {
						return sidePositions[i];
					}
				}
				return null;
			};
			var getFirstFreeAnglePosition = function() {
				for(var i=0;i<anglePositions.length;i++) {
					if($scope.states[anglePositions[i]].state == null) {
						return anglePositions[i];
					}
				}
				return null;
			}
			var getFirstFree = function() {
				for(var i=0;i<9;i++) {
					if($scope.states[i].state == null) {
						return i;
					}
				}
				return null;
			};
			var isAnglePosition = function(isCross, position) {
				for(var i=0;i<anglePositions.length;i++) {
					if(position == anglePositions[i] && $scope.states[anglePositions[i]].state == isCross) {
						return true;
					}
				}
				return false;
			};
			var isSidePosition = function(isCross, position) {
				for(var i=0;i<sidePositions.length;i++) {
					if(position== sidePositions[i] && $scope.states[sidePositions[i]].state == isCross) {
						return true;
					}
				}
				return false;
			};
			//--- checks if current player won
			var ifWin = function(isCross,futurePosition) {
				//--- calculate sum of current elements
				var tempSum = 0; 
				for(var i=0;i<9;i++) {
			 		if($scope.states[i].state == isCross) {		 				
		 					tempSum |= Math.pow(2,i);
		 			}
			 	}
			 	//--- if future position specified then take it into consideration too
			 	if(futurePosition != null) {
			 		tempSum |= Math.pow(2,futurePosition);
			 	}
		 		//--- ... and compare it with one of the sums
		 		for(var s=0;s<winSums.length;s++) {
		 			if((winSums[s] & tempSum) == winSums[s])
		 				return true;
		 		}
		 		//---
		 		return false;
			};
			//-- checks whether cells with empty data exists
			var ifNoPlaceToGo = function() {
				for(var i=0;i<9;i++) {
			 		if($scope.states[i].state == null) {
			 			return false;		 				
			 		}
			 	}
			 	return true;
			};
		}
	</script>
	</body>
</html>