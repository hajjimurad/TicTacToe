<!DOCTYPE html>
<html>
	<head>
		<title>Tic Tac Toe</title>
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.3.2/united/bootstrap.min.css" />
		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular.js"></script>
	</head>
	<body ng-app>
		<style type="text/css">
			.game {
				width: 302px;
				margin: 20px auto;
				overflow: hidden;
				font-family: u2400;
			}
			.game div {
				width: 100px; 
				height: 100px; 
				border: solid 1px #000; 
				float: left;
				font-size: 64px;
				text-align: center;
			}
			.result {
				text-align: center;
				padding: 4px;
			}
		</style>
		<div ng-controller="GameController" ng-model="state">
			<div class="game">
				<div ng-repeat="item in states" ng-click="onUserRun(item, $index)">
					{{showState(item)}}
				</div>
			</div>
			<h3 class="result">{{showResult(gameResult)}}</h3>
		</div>
		<script type="text/javascript">
		//--- entry point for game
		var GameController = function($scope) {
			var winSums = [7, 56, 448, 73, 146, 292, 273, 84];
			var anglePositions = [0,2,6,8];
			var sidePositions = [1,3,5,7];
			var centralPosition = 4;
			var isCross;
			var resetRequired = false;
			var computerStrategy = null;
			var stepCounter = 0;
			var prevOpponentPosition;
			var firstOpponentPosition;
			//---
			var init = function() {
				$scope.gameResult = null;
				//--- game starts with cross
				var before = isCross;
				isCross = 1;
				//--- model initial state
				$scope.states = [];
				 	for(var i=0; i<9; i++) {
				 		$scope.states.push({ state: null });
			 	};
			}
			//---
			init();
			//--- data to view
			$scope.showState = function(item) {
				if(item.state  == 0) return "⭕";
				if(item.state == 1) return "❌";
			}
			//--- shows game result
			$scope.showResult = function(gameResult) {
				switch(gameResult) {
					case 0:
						return 'Nobody won!';
					break;
					case 1:
						return '⭐ Win of user \'X\' ⭐';
					break;
					case 2:
						return '⭐ Win of user \'O\' ⭐';
					break;
					default:
						return null;
					break;
				}
			}
            //---   				     
			$scope.onUserRun = function(item, index) {
				//--- game is finished
				if(resetRequired) {
					resetRequired = false;
					init();
					return;
				}
				//---
				if(item.state == null) {
					//--- update cell with new status
					item.state = isCross;
					//--- check is result received
					if(isGameFinished()) {
						resetRequired = true;
						return;
					}
					//---
					stepCounter++;
					//--- 
					prevOpponentPosition = index;
					if(stepCounter == 1) {
						firstOpponentPosition = index;
					}
					//---
					computerRun((isCross + 1) % 2);
					//---
					if(isGameFinished()) {
						resetRequired = true;
						return;
					}
				}				
			}
			var isGameFinished = function() {
				//--- check if won X
				if(ifWin(0)) {
					$scope.gameResult = 2;
					//---
					return true;
				}
				//--- check if won 0
				if(ifWin(1)) {
					$scope.gameResult = 1;
					//---
					return true;
				}
				//--- check if game finished
				if(ifNoPlaceToGo()) {
					$scope.gameResult = 0;
					return true;
				}
				//---
				return false;
			}
			var computerRun = function(isCross) {
				var chosen = false;
				var emptyPositions = [];
				//--- 'IF I CAN WIN THEN WIN'
				for(var i=0;i<9;i++) {
					if($scope.states[i].state == null) {
						//--- check if computer can win
						if(ifWin(isCross, i)) {
							console.log("choose '" + i + "', because I can win");
							$scope.states[i].state = isCross;
							chosen = true;							
							break;
						}
						emptyPositions.push(i);
					}
				}
				if(chosen)
					return;
				//--- 'IF OPPONENT CAN WIN AT NEXT STEP THEN GO THERE'
				var opponentSymbol = (isCross + 1) % 2;
				for(var i=0;i<9;i++) {
					if($scope.states[i].state == null) {
						//--- check if opponent can win
						if(ifWin(opponentSymbol, i)) {
							console.log("choose '" + i + "', because opponent can win");
							$scope.states[i].state = isCross;
							chosen = true;				
							break;
						}
					}
				}
				if(chosen)
					return;
				//--- choose strategy
				if(!computerStrategy) {
					if(stepCounter == 1) {
						if($scope.states[centralPosition].state == 1) {
							computerStrategy = 1;
						}
						else if(isAnglePosition(opponentSymbol, prevOpponentPosition)) {
							computerStrategy = 2;
						}
						else if(isSidePosition(opponentSymbol, prevOpponentPosition)) {
							computerStrategy = 3;
						}
					}
				}
				//--- act by selected strategy
				if(computerStrategy == 1) {
					//--- choose any angle cell or random
					var anglePos = getFirstFreeAnglePosition();
					if(anglePos != null) {
						console.log("choose '" + anglePos+ "', because opponent get center first (strategy 1)");
						$scope.states[anglePos].state = isCross;
						chosen = true;
					} else {
						var anyFreePosition = getFirstFree();
						console.log("choose '" + anglePos+ "', because opponent get center first and angle positions are not free (strategy 1)");
						$scope.states[anyFreePosition].state = isCross;
						chosen = true;
					}
				} else if(computerStrategy == 2) {
					if(stepCounter == 1) {
						console.log("choose '" + centralPosition+ "', because opponent get angle (strategy 2)");
						$scope.states[centralPosition].state = isCross;
						chosen = true;
					} else if (stepCounter == 2) {
						//--- find opposite position
						var oppositePositions = getPositionOpposite(firstOpponentPosition);
						if($scope.states[oppositePositions].state != null) {
							//--- opposite position is used => find any at side
							var positionAtSide = getFirstFreeAtSide();
							console.log("choose '" + positionAtSide+ "', because second step, at side (strategy 2)");
							$scope.states[positionAtSide].state = isCross;
							chosen = true;
						} else {
							//--- go here
							console.log("choose '" + oppositePositions+ "', because second step, opposite (strategy 2)");
							$scope.states[oppositePositions].state = isCross;
							chosen = true;
						}
					}
				} else if(computerStrategy == 3) {
					if(stepCounter == 1) {
						console.log("choose '" + centralPosition+ "', because first step was at side (strategy 3.0)");
						$scope.states[centralPosition].state = isCross;
						chosen = true;
					} else if(stepCounter == 2) {
						var tempPos;
						//----
						if(isAnglePosition(opponentSymbol, prevOpponentPosition)) {
							var oppositePosition = getPositionOpposite(prevOpponentPosition);
							console.log("choose '" + oppositePosition+ "', because second step was at angle " + prevOpponentPosition + " (strategy 3.1)");
							$scope.states[oppositePosition].state = isCross;
							chosen = true;
						} else if(getPositionOpposite(prevOpponentPosition) == firstOpponentPosition) {
							var firstFreeAnglePosition = getFirstFreeAnglePosition();
							console.log("choose '" + firstFreeAnglePosition+ "', because second step was at opposite to the first side (strategy 3.2)");
							$scope.states[firstFreeAnglePosition].state = isCross;
							chosen = true;
						} else if(ifPositionNearAndAtSideToTheFirst(opponentSymbol,prevOpponentPosition,firstOpponentPosition, function(pos) { tempPos = pos})) {
							console.log("choose '" + tempPos+ "', because second step was near at side (strategy 3.3)");
							$scope.states[tempPos].state = isCross;
							chosen = true;
						}
					}

				}
				if(chosen)
					return;
				//--- choose random if no cell selected
				if(emptyPositions.length > 0) {
					var firstFree = getFirstFree();
					$scope.states[firstFree].state = isCross;
					console.log("choose first free!!!");
				}
			}
			var ifPositionNearAndAtSideToTheFirst = function(isCross, position, firstPosition, callback) {
				if(!callback)
					return null;
				//---
				if(!isSidePosition(isCross,position)) {
					throw "position is not side to check if both are neighbours";
				}
				switch(position) {
					case 1:
						if(firstPosition == 3) { callback(0); return true; }
						if(firstPosition == 5) { callback(2); return true; }
					break; 
					case 3: 
						if(firstPosition == 1) { callback(0); return true; }
						if(firstPosition == 7) { callback(6); return true; }
					break; 
					case 5: 
						if(firstPosition == 1) { callback(2); return true; }
						if(firstPosition == 7) { callback(8); return true; }
					break; 
					case 7: 
						if(firstPosition == 3) { callback(6); return true; }
						if(firstPosition == 5) { callback(8); return true; }
					break;
				}
				//---
				return false;
			}
			var getPositionOpposite = function(sourcePosition) {
				if(sourcePosition == undefined) {
					throw "invalid position specified to get opposite, undefined";
				}
				if(sourcePosition == centralPosition) {
					throw "invalid position specified to get opposite, opposite";
				}
				var x = sourcePosition % 3;
				var y = (sourcePosition - x) / 3;
				var oppositeX = 2 - x;;
				var oppositeY = 2 - y;
				return oppositeY * 3 + oppositeX;
			}
			var getFirstFreeAtSide = function() {
				for(var i=0;i<sidePositions.length;i++) {
					if($scope.states[sidePositions[i]].state == null) {
						return sidePositions[i];
					}
				}
				return null;
			}
			var getFirstFreeAnglePosition = function() {
				for(var i=0;i<anglePositions.length;i++) {
					if($scope.states[anglePositions[i]].state == null) {
						return anglePositions[i];
					}
				}
				return null;
			}
			var getFirstFree = function() {
				for(var i=0;i<9;i++) {
					if($scope.states[i].state == null) {
						return i;
					}
				}
				return null;
			}
			var isAnglePosition = function(isCross, position) {
				for(var i=0;i<anglePositions.length;i++) {
					if(position == anglePositions[i] && $scope.states[anglePositions[i]].state == isCross) {
						return true;
					}
				}
				return false;
			}
			var isSidePosition = function(isCross, position) {
				for(var i=0;i<sidePositions.length;i++) {
					if(position== sidePositions[i] && $scope.states[sidePositions[i]].state == isCross) {
						return true;
					}
				}
				return false;
			}
			//--- checks if current player won
			var ifWin = function(isCross,futurePosition) {
				//--- calculate sum of current elements
				var tempSum = 0; 
				for(var i=0;i<9;i++) {
			 		if($scope.states[i].state == isCross) {		 				
		 					tempSum |= Math.pow(2,i);
		 			}
			 	}
			 	//--- if future position specified then take it into consideration too
			 	if(futurePosition != null) {
			 		tempSum |= Math.pow(2,futurePosition);
			 	}
		 		//--- ... and compare it with one of the sums
		 		for(var s=0;s<winSums.length;s++) {
		 			if((winSums[s] & tempSum) == winSums[s])
		 				return true;
		 		}
		 		//---
		 		return false;
			}
			//-- checks whether cells with empty data exists
			var ifNoPlaceToGo = function() {
				for(var i=0;i<9;i++) {
			 		if($scope.states[i].state == null) {
			 			return false;		 				
			 		}
			 	}
			 	return true;
			}
		}
	</script>
	</body>
</html>