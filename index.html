<!DOCTYPE html>
<html>
	<head>
		<title>Tic Tac Toe</title>
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.3.2/united/bootstrap.min.css" />
		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular.js"></script>
	</head>
	<body ng-app>
		<style type="text/css">
			.game {
				width: 302px;
				margin: 20px auto;
				overflow: hidden;
			}
			.game div {
				width: 100px; 
				height: 100px; 
				border: solid 1px #000; 
				float: left;
				font-size: 64px;
				text-align: center;
			}
			.result {
				text-align: center;
				padding: 4px;
			}
		</style>
		<div ng-controller="GameController" ng-model="state">
			<div class="game">
				<div ng-repeat="item in states" ng-click="onUserRun(item)">
					{{showState(item)}}
				</div>
			</div>
			<h3 class="result">{{resultMessage}}</h3>
		</div>
		<script type="text/javascript">
		//--- entry point for game
		var GameController = function($scope) {
			var winSums = [7, 56, 448, 73, 146, 292, 273, 84];
			var anglePositions = [0,2,6,8];
			var centralPosition = 4;
			var isCross;
			var resetRequired = false;
			var computerStrategy = null;
			var stepCounter = 0;
			var savedFirstPositionAtStrategy2;
			//---
			$scope.init = function() {
				$scope.resultMessage = "";
				//--- game starts with cross
				var before = isCross;
				isCross = 1;
				//--- model initial state
				$scope.states = [];
				 	for(var i=0; i<9; i++) {
				 		$scope.states.push({ state: null });
			 	};
			}
			//---
			$scope.init();
            //---   				     
			$scope.onUserRun = function(item) {
				//--- game is finished
				if(resetRequired) {
					resetRequired = false;
					$scope.init();
					return;
				}
				//---
				if(item.state == null) {
					//--- update cell with new status
					item.state = isCross;
					//--- check is result received
					if($scope.isGameFinished()) {
						resetRequired = true;
						return;
					}
					//---
					stepCounter++;
					//---
					$scope.computerRun((isCross + 1) % 2);
					//---
					if($scope.isGameFinished()) {
						resetRequired = true;
						return;
					}
				}				
			}
			$scope.isGameFinished = function() {
				//--- check if won X
				if($scope.ifWin(0)) {
					$scope.resultMessage = '⭐ Win of user \'0\' ⭐';
					//---
					return true;
				}
				//--- check if won 0
				if($scope.ifWin(1)) {
					$scope.resultMessage = '⭐ Win of user \'X\' ⭐';
					//---
					return true;
				}
				//--- check if game finished
				if($scope.ifNoPlaceToGo()) {
					$scope.resultMessage = 'Nobody won!';;
					return true;
				}
				//---
				return false;
			}
			$scope.computerRun = function(isCross) {
				// var statesTogether = "";
				// for(var i=0;i<9;i++) {
				// 	statesTogether += $scope.states[i].state + ",";
				// }
				// console.log(statesTogether);
				//---
				var chosen = false;
				var emptyPositions = [];
				//--- 'IF I CAN WIN THEN WIN'
				for(var i=0;i<9;i++) {
					if($scope.states[i].state == null) {
						//--- check if computer can win
						if($scope.ifWin(isCross, i)) {
							console.log("choose '" + i + "', because I can win");
							$scope.states[i].state = isCross;
							chosen = true;							
							break;
						}
						emptyPositions.push(i);
					}
				}
				if(chosen)
					return;
				//--- 'IF OPPONENT CAN WIN AT NEXT STEP THEN GO THERE'
				var opponentSymbol = (isCross + 1) % 2;
				for(var i=0;i<9;i++) {
					if($scope.states[i].state == null) {
						//--- check if opponent can win
						if($scope.ifWin(opponentSymbol, i)) {
							console.log("choose '" + i + "', because opponent can win");
							$scope.states[i].state = isCross;
							chosen = true;				
							break;
						}
					}
				}
				if(chosen)
					return;
				//--- choose strategy
				if(!computerStrategy) {
					if(stepCounter == 1) {
						if($scope.states[centralPosition].state == 1) {
							computerStrategy = 1;
						}
						else if($scope.doesAnyAnglePositionsContains(opponentSymbol, function(pos) { savedFirstPositionAtStrategy2 = pos;})) {
							computerStrategy = 2;
						}
					}
				}
				//--- act by selected strategy
				if(computerStrategy == 1) {
					//--- choose any angle cell or random
					var anglePos = $scope.getFirstFreeAnglePosition();
					if(anglePos != null) {
						console.log("choose '" + anglePos+ "', because opponent get center first (strategy 1)");
						$scope.states[anglePos].state = isCross;
						chosen = true;
					} else {
						var anyFreePosition = $scope.getAnyFreePosition();
						console.log("choose '" + anglePos+ "', because opponent get center first and angle positions are not free (strategy 1)");
						$scope.states[anyFreePosition].state = isCross;
						chosen = true;
					}
				} else if(computerStrategy == 2) {
					if(stepCounter == 1) {
						console.log("choose '" + centralPosition+ "', because opponent get angle (strategy 2)");
						$scope.states[centralPosition].state = isCross;
						chosen = true;
					} else if (stepCounter == 2) {
						//--- find opposite position
						var x = savedFirstPositionAtStrategy2 % 3;
						var y = (savedFirstPositionAtStrategy2 - x) / 3;
						var oppositeX = x > 0 ? 0 : 2;
						var oppositeY = y > 0 ? 0 : 2;
						var newPosition = oppositeY * 3 + oppositeX;
						if($scope.states[newPosition].state != null) {
							//--- already used => find any at side
						} else {
							//--- go here
							console.log("choose '" + centralPosition+ "', because second step (strategy 2)");
							$scope.states[newPosition].state = isCross;
							chosen = true;
						}
					}
				}
				if(chosen)
					return;
				//--- choose random if no cell selected
				if(emptyPositions.length > 0) {
					var random = $scope.getRand(0,emptyPositions.length - 1);
					$scope.states[emptyPositions[random]].state = isCross;
					console.log("choose rand: " + emptyPositions[random]);
				}
			}
			$scope.getFirstFreeAnglePosition = function() {
				for(var i=0;i<anglePositions.length;i++) {
					if($scope.states[anglePositions[i]].state == null) {
						return anglePositions[i];
					}
				}
				return null;
			}
			$scope.doesAnyAnglePositionsContains = function(isCross, callback) {
				for(var i=0;i<anglePositions.length;i++) {
					if($scope.states[anglePositions[i]].state == isCross) {
						if(callback) { callback(anglePositions[i])}
						return true;
					}
				}
				return false;
			}
			$scope.getAnyFreePosition = function() {
				for(var i=0;i<9;i++) {
					if($scope.states[i].state == null) {
						return i;
					}
				}
				return null;
			}
			$scope.getRand = function(min,max) {
				return Math.floor(Math.random() * (max - min + 1)) + min;
			}
			//--- data to view
			$scope.showState = function(item) {
				if(item.state  == 0) return "⭕";
				if(item.state == 1) return "❌";
			}
			//--- checks if current player won
			$scope.ifWin = function(isCross,futurePosition) {
				//--- calculate sum of current elements
				var tempSum = 0; 
				for(var i=0;i<9;i++) {
			 		if($scope.states[i].state == isCross) {		 				
		 					tempSum |= Math.pow(2,i);
		 			}
			 	}
			 	//--- if future position specified then take it into consideration too
			 	if(futurePosition != null) {
			 		tempSum |= Math.pow(2,futurePosition);
			 	}
		 		//--- ... and compare it with one of the sums
		 		for(var s=0;s<winSums.length;s++) {
		 			if((winSums[s] & tempSum) == winSums[s])
		 				return true;
		 		}
		 		//---
		 		return false;
			}
			//-- checks whether cells with empty data exists
			$scope.ifNoPlaceToGo = function() {
				for(var i=0;i<9;i++) {
			 		if($scope.states[i].state == null) {
			 			return false;		 				
			 		}
			 	}
			 	return true;
			}
		}
	</script>
	</body>
</html>